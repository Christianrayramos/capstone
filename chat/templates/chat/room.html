{% extends "chat/layout.html" %}


{% block body %}
    {% if user.is_authenticated %}
        <div class="center">
            <div class="container py-4" style="max-width: 600px;">
                <div class="card shadow rounded-3" style="height: 80vh;">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 flex-grow-1 text-center">{{ room.name }}</h5>
                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#roomInfoModal">
                        <i class="bi bi-info-circle"></i> <!-- Bootstrap icon -->
                    </button>
                  </div>
                  
                  <div id="chat-messages" class="card-body overflow-auto d-flex flex-column"
                    style="flex-grow: 1; max-height: 70vh;">
                    {% for msg in messages %}
                        {% if msg.sender == request.user %}
                        <!-- Current user (align right) -->
                        <div class="d-flex justify-content-end mb-2">   <!-- container of the chat-->
                            <div class=" d-flex flex-column align-items-end"> <!-- stack top to bot vertical-->
                                <span class="badge bg-primary text-wrap p-2">{{ msg.content }}</span>
                                <small class="text-muted">Me</small>
                            </div>
                        </div>
                        {% else %}
                        <!-- Other users (align left) -->
                        <div class="d-flex justify-content-start mb-2">
                            <div class="d-flex flex-column align-items-start">
                            <span class="badge bg-secondary text-wrap p-2">{{ msg.content }}</span>
                            <small class="text-muted">{{ msg.sender.username }}</small>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                  <!-- Chat input -->
                  <div class="card-footer">
                    <form id="chatForm" class="d-flex">
                      <input id="chatMessageInput" type="text" class="form-control me-2" placeholder="Type a message..." required>
                      <button id="sendbtn" type="submit" class="btn btn-primary">Send</button>
                    </form>
                  </div>
                </div>
              </div>
        </div>

        <div class="modal fade" id="roomInfoModal" tabindex="-1" aria-labelledby="roomInfoLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="roomInfoLabel">Group Info</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Group Name:</strong> {{ room.name }}</p>
                        <p><strong>Created On:</strong> {{ room.created_at|date:"F j, Y" }}</p>
                        <hr>
                        <p><strong>Members:</strong></p>
                        <ul>
                            {% for member in room.participants.all %}
                                <li>{{ member.username }}</li>
                            {% empty %}
                                <li>No members yet</li>
                            {% endfor %}
                            </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <script>
        const roomName = "{{ room.name }}"; 
        const chatSocket = new WebSocket(
            "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const div = document.createElement("div");
            div.className = (data.sender === "{{ request.user.username }}") 
                ? "d-flex justify-content-end mb-2"
                : "d-flex justify-content-start mb-2";

            const inner = document.createElement("div");
            inner.className = (data.sender === "{{ request.user.username }}")
                ? "d-flex flex-column align-items-end"
                : "d-flex flex-column align-items-start";

            const text = document.createElement('span');
            text.className = (data.sender === "{{ request.user.username }}")
                ? "badge bg-primary text-wrap p-2"
                : "badge bg-secondary text-wrap p-2";
            text.innerText = data.message;

            const small = document.createElement('small');
            small.className = 'text-muted';
            small.innerText = (data.sender === "{{ request.user.username }}")? "Me": data.sender;

            inner.appendChild(text);
            inner.appendChild(small);
            div.appendChild(inner);

            document.querySelector("#chat-messages").appendChild(div);

        };

        window.addEventListener("load", () => {
            const box = document.getElementById("chat-messages");
            box.scrollTop = box.scrollHeight;
        }, 50);

        const form = document.getElementById("chatForm");
        form.addEventListener("submit", function(e) {
            e.preventDefault();       // stop page reload
            const input = document.getElementById("chatMessageInput");
            const box = document.getElementById("chat-messages");
            box.scrollTop = box.scrollHeight;
            if (input.value.trim() === "") return;  // ignore empty messages 

            chatSocket.send(JSON.stringify({
                "message": input.value,
                "sender": "{{ request.user.username }}"
            }));
            input.value = "";

            const msgBox = document.getElementById("chat-messages");
            requestAnimationFrame(() => {
                msgBox.scrollTop = msgBox.scrollHeight;
            });
            
        });
    </script>
{% endblock %}




                       